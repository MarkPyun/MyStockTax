{% extends "base.html" %}

{% block title %}MyStockTax - Economy & Trade{% endblock %}

{% block extra_css %}
<style>
    .chart-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        z-index: 10;
    }
    
    .chart-loading-overlay i {
        color: #3498db;
    }
    
    .progress-step {
        font-size: 0.85rem;
        margin: 0.3rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- 페이지 헤더 -->
    <div class="mb-4">
        <h2 class="text-primary fw-bold">
            <i class="fas fa-globe me-2"></i>
            Economy & Trade
        </h2>
        <p class="text-muted">미국 경제 지표 및 글로벌 트레이드 분석</p>
        <hr>
    </div>
    
    <!-- 에러 메시지 -->
    <div id="errorMessage" class="alert alert-danger" style="display: none;" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span id="errorText"></span>
    </div>
    
    <!-- 로딩 메시지 및 Progress Bar -->
    <div id="loadingMessage" class="text-center text-muted" style="display: none;">
        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
        <p id="loadingText">데이터를 조회하고 있습니다...</p>
        
        <!-- Progress Bar -->
        <div class="progress mt-3" style="max-width: 500px; margin: 0 auto; height: 30px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" 
                 style="width: 0%;" 
                 aria-valuenow="0" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
                <span id="progressText">0%</span>
            </div>
        </div>
        
        <!-- Progress Steps -->
        <div class="mt-3" style="max-width: 500px; margin: 0 auto;">
            <div class="d-flex justify-content-center align-items-center flex-wrap gap-3">
                <span id="step1" class="progress-step text-muted">
                    <i class="fas fa-circle" style="font-size: 5px;"></i> 미국 국채금리
                </span>
                <span id="step2" class="progress-step text-muted">
                    <i class="fas fa-circle" style="font-size: 5px;"></i> CPI
                </span>
                <span id="step3" class="progress-step text-muted">
                    <i class="fas fa-circle" style="font-size: 5px;"></i> 제조업생산지수
                </span>
                <span id="step4" class="progress-step text-muted">
                    <i class="fas fa-circle" style="font-size: 5px;"></i> 실업률
                </span>
                <span id="step5" class="progress-step text-muted">
                    <i class="fas fa-circle" style="font-size: 5px;"></i> GDP
                </span>
                <span id="step6" class="progress-step text-muted">
                    <i class="fas fa-circle" style="font-size: 5px;"></i> S&P 500
                </span>
                <span id="step7" class="progress-step text-muted">
                    <i class="fas fa-circle" style="font-size: 5px;"></i> 버핏지수
                </span>
                <span id="step8" class="progress-step text-muted">
                    <i class="fas fa-circle" style="font-size: 5px;"></i> 주택재고량
                </span>
                <span id="step9" class="progress-step text-muted">
                    <i class="fas fa-circle" style="font-size: 5px;"></i> 모기지연체율
                </span>
            </div>
        </div>
    </div>
    
    <!-- 차트 컨테이너 -->
    <div id="chartContainer" style="display: none;">
        
        <!-- 1. 미국 국채금리 Chart -->
        <div class="mb-4">
            <h4 class="mb-3">
                1. 미국 국채금리 (5년물 vs 3개월물)
                <button class="btn btn-sm btn-outline-success ms-2" onclick="refreshTreasuryData()" title="국채금리 데이터 새로고침">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </h4>
            <div class="card" style="position: relative;">
                <div class="card-body" style="height: 400px;">
                    <canvas id="treasuryChart"></canvas>
                </div>
                <!-- 국채금리 차트 개별 로딩 오버레이 -->
                <div id="treasuryChartLoading" class="chart-loading-overlay" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p class="mb-0"><small id="treasuryLoadingText">새로고침 중...</small></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 2. CPI Chart -->
        <div class="mb-4">
            <h4 class="mb-3">
                2. CPI (소비자물가지수)
                <button class="btn btn-sm btn-outline-success ms-2" onclick="refreshCPIData()" title="CPI 데이터 새로고침">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </h4>
            <div class="card" style="position: relative;">
                <div class="card-body" style="height: 400px;">
                    <canvas id="cpiChart"></canvas>
                </div>
                <!-- CPI 차트 개별 로딩 오버레이 -->
                <div id="cpiChartLoading" class="chart-loading-overlay" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p class="mb-0"><small id="cpiLoadingText">새로고침 중...</small></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 3. 제조업 생산지수 Chart -->
        <div class="mb-4">
            <h4 class="mb-3">
                3. 제조업 생산지수 (Industrial Production)
                <button class="btn btn-sm btn-outline-success ms-2" onclick="refreshIndustrialProductionData()" title="제조업 생산지수 데이터 새로고침">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </h4>
            <div class="card" style="position: relative;">
                <div class="card-body" style="height: 400px;">
                    <canvas id="indproChart"></canvas>
                </div>
                <!-- 제조업 생산지수 차트 개별 로딩 오버레이 -->
                <div id="indproChartLoading" class="chart-loading-overlay" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p class="mb-0"><small id="indproLoadingText">새로고침 중...</small></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 4. 실업률 Chart -->
        <div class="mb-4">
            <h4 class="mb-3">
                4. 실업률 (Unemployment Rate)
                <button class="btn btn-sm btn-outline-success ms-2" onclick="refreshUnemploymentData()" title="실업률 데이터 새로고침">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </h4>
            <div class="card" style="position: relative;">
                <div class="card-body" style="height: 400px;">
                    <canvas id="unemploymentChart"></canvas>
                </div>
                <!-- 실업률 차트 개별 로딩 오버레이 -->
                <div id="unemploymentChartLoading" class="chart-loading-overlay" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p class="mb-0"><small id="unemploymentLoadingText">새로고침 중...</small></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 5. GDP Chart -->
        <div class="mb-4">
            <h4 class="mb-3">
                5. GDP (국내총생산)
                <button class="btn btn-sm btn-outline-success ms-2" onclick="refreshGDPData()" title="GDP 데이터 새로고침">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </h4>
            <div class="card" style="position: relative;">
                <div class="card-body" style="height: 400px;">
                    <canvas id="gdpChart"></canvas>
                </div>
                <!-- GDP 차트 개별 로딩 오버레이 -->
                <div id="gdpChartLoading" class="chart-loading-overlay" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p class="mb-0"><small id="gdpLoadingText">새로고침 중...</small></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 6. S&P 500 Chart -->
        <div class="mb-4">
            <h4 class="mb-3">
                6. S&P 500 지수
                <button class="btn btn-sm btn-outline-success ms-2" onclick="refreshSP500Data()" title="S&P 500 데이터 새로고침">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </h4>
            <div class="card" style="position: relative;">
                <div class="card-body" style="height: 400px;">
                    <canvas id="sp500Chart"></canvas>
                </div>
                <!-- S&P 500 차트 개별 로딩 오버레이 -->
                <div id="sp500ChartLoading" class="chart-loading-overlay" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p class="mb-0"><small id="sp500LoadingText">새로고침 중...</small></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 7. 버핏지수 Chart -->
        <div class="mb-4">
            <h4 class="mb-3">
                7. 버핏지수 (Buffett Indicator)
                <button class="btn btn-sm btn-outline-success ms-2" onclick="refreshBuffettIndicatorData()" title="버핏지수 데이터 새로고침">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <small class="text-muted ms-2" style="font-size: 0.8rem;">
                    (총 시장 시가총액 / GDP × 100)
                </small>
            </h4>
            <div class="card" style="position: relative;">
                <div class="card-body">
                    <div style="height: 400px;">
                        <canvas id="buffettIndicatorChart"></canvas>
                    </div>
                    <div class="mt-3 text-muted" style="font-size: 0.9rem;">
                        <strong>해석:</strong>
                        <span class="text-success">100% 이하: 저평가</span> |
                        <span class="text-primary">100-115%: 적정</span> |
                        <span class="text-danger">115% 이상: 과대평가</span>
                    </div>
                </div>
                <!-- 버핏지수 차트 개별 로딩 오버레이 -->
                <div id="buffettIndicatorChartLoading" class="chart-loading-overlay" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p class="mb-0"><small id="buffettIndicatorLoadingText">새로고침 중...</small></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 8. 주택재고량 Chart -->
        <div class="mb-4">
            <h4 class="mb-3">
                8. 주택재고량 (Housing Inventory)
                <button class="btn btn-sm btn-outline-success ms-2" onclick="refreshHousingInventoryData()" title="주택재고량 데이터 새로고침">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <small class="text-muted ms-2" style="font-size: 0.8rem;">
                    (월별 공급 - 개월 수)
                </small>
            </h4>
            <div class="card" style="position: relative;">
                <div class="card-body">
                    <div style="height: 400px;">
                        <canvas id="housingInventoryChart"></canvas>
                    </div>
                    <div class="mt-3 text-muted" style="font-size: 0.9rem;">
                        <strong>해석:</strong>
                        <span class="text-success">4-5개월: 수요 강세 (Seller's Market)</span> |
                        <span class="text-primary">6-7개월: 균형</span> |
                        <span class="text-danger">8개월 이상: 공급 과잉 (Buyer's Market)</span>
                    </div>
                </div>
                <!-- 주택재고량 차트 개별 로딩 오버레이 -->
                <div id="housingInventoryChartLoading" class="chart-loading-overlay" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p class="mb-0"><small id="housingInventoryLoadingText">새로고침 중...</small></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 9. 모기지 연체율 Chart -->
        <div class="mb-4">
            <h4 class="mb-3">
                9. 모기지 연체율 (Mortgage Delinquency Rate)
                <button class="btn btn-sm btn-outline-success ms-2" onclick="refreshMortgageDelinquencyData()" title="모기지 연체율 데이터 새로고침">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <small class="text-muted ms-2" style="font-size: 0.8rem;">
                    (주거용 모기지 연체율 %)
                </small>
            </h4>
            <div class="card" style="position: relative;">
                <div class="card-body">
                    <div style="height: 400px;">
                        <canvas id="mortgageDelinquencyChart"></canvas>
                    </div>
                    <div class="mt-3 text-muted" style="font-size: 0.9rem;">
                        <strong>해석:</strong>
                        <span class="text-success">2% 미만: 안정적</span> |
                        <span class="text-primary">2-4%: 정상 범위</span> |
                        <span class="text-warning">4-6%: 주의</span> |
                        <span class="text-danger">6% 이상: 위험 (부동산 위기 가능성)</span>
                    </div>
                </div>
                <!-- 모기지 연체율 차트 개별 로딩 오버레이 -->
                <div id="mortgageDelinquencyChartLoading" class="chart-loading-overlay" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p class="mb-0"><small id="mortgageDelinquencyLoadingText">새로고침 중...</small></p>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- 빈 상태 메시지 -->
    <div id="emptyState" class="text-center text-muted mt-5">
        <i class="fas fa-chart-line fa-3x mb-3"></i>
        <p>페이지를 로딩하고 있습니다...</p>
    </div>
</div>

<script>
    let treasuryChart = null;
    
    // 페이지 로드시 자동으로 데이터 로딩
    document.addEventListener('DOMContentLoaded', function() {
        performLoad();
    });
    
    // 로딩 표시
    function showLoading() {
        document.getElementById('loadingMessage').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('chartContainer').style.display = 'none';
    }
    
    // 로딩 숨기기
    function hideLoading() {
        document.getElementById('loadingMessage').style.display = 'none';
    }
    
    // 차트 표시
    function showChart() {
        document.getElementById('chartContainer').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
        hideLoading();
    }
    
    // 에러 메시지 표시
    function showError(message) {
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        errorText.textContent = message;
        errorMessage.style.display = 'block';
        hideLoading();
        
        // 5초 후 자동 숨김
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }
    
    // Progress Bar 업데이트 함수
    function updateProgress(percentage, message, stepNumber) {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const loadingText = document.getElementById('loadingText');
        
        if (progressBar) {
            progressBar.style.width = percentage + '%';
            progressBar.setAttribute('aria-valuenow', percentage);
            progressText.textContent = percentage + '%';
        }
        
        if (loadingText && message) {
            loadingText.textContent = message;
        }
        
        // 단계별 아이콘 업데이트
        if (stepNumber >= 1) {
            document.getElementById('step1').innerHTML = '<i class="fas fa-check-circle text-success"></i> 미국 국채금리';
        }
        if (stepNumber >= 2) {
            document.getElementById('step2').innerHTML = '<i class="fas fa-check-circle text-success"></i> CPI';
        }
        if (stepNumber >= 3) {
            document.getElementById('step3').innerHTML = '<i class="fas fa-check-circle text-success"></i> 제조업생산지수';
        }
        if (stepNumber >= 4) {
            document.getElementById('step4').innerHTML = '<i class="fas fa-check-circle text-success"></i> 실업률';
        }
        if (stepNumber >= 5) {
            document.getElementById('step5').innerHTML = '<i class="fas fa-check-circle text-success"></i> GDP';
        }
        if (stepNumber >= 6) {
            document.getElementById('step6').innerHTML = '<i class="fas fa-check-circle text-success"></i> S&P 500';
        }
        if (stepNumber >= 7) {
            document.getElementById('step7').innerHTML = '<i class="fas fa-check-circle text-success"></i> 버핏지수';
        }
        if (stepNumber >= 8) {
            document.getElementById('step8').innerHTML = '<i class="fas fa-check-circle text-success"></i> 주택재고량';
        }
        if (stepNumber >= 9) {
            document.getElementById('step9').innerHTML = '<i class="fas fa-check-circle text-success"></i> 모기지연체율';
        }
    }
    
    // Progress Bar 초기화 함수
    function resetProgress() {
        updateProgress(0, '데이터를 조회하고 있습니다...', 0);
        document.getElementById('step1').innerHTML = '<i class="fas fa-circle" style="font-size: 5px;"></i> 미국 국채금리';
        document.getElementById('step2').innerHTML = '<i class="fas fa-circle" style="font-size: 5px;"></i> CPI';
        document.getElementById('step3').innerHTML = '<i class="fas fa-circle" style="font-size: 5px;"></i> 제조업생산지수';
        document.getElementById('step4').innerHTML = '<i class="fas fa-circle" style="font-size: 5px;"></i> 실업률';
        document.getElementById('step5').innerHTML = '<i class="fas fa-circle" style="font-size: 5px;"></i> GDP';
        document.getElementById('step6').innerHTML = '<i class="fas fa-circle" style="font-size: 5px;"></i> S&P 500';
        document.getElementById('step7').innerHTML = '<i class="fas fa-circle" style="font-size: 5px;"></i> 버핏지수';
        document.getElementById('step8').innerHTML = '<i class="fas fa-circle" style="font-size: 5px;"></i> 주택재고량';
        document.getElementById('step9').innerHTML = '<i class="fas fa-circle" style="font-size: 5px;"></i> 모기지연체율';
    }
    
    // 데이터 자동 로딩
    async function performLoad() {
        showLoading();
        resetProgress();
        
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';
        
        try {
            // 1. 국채금리 데이터 로딩 (0% → 25%)
            updateProgress(15, '미국 국채금리 데이터를 처리하고 있습니다...', 0);
            const treasurySuccess = await processTreasuryData();
            if (treasurySuccess) {
                updateProgress(25, '미국 국채금리 데이터 처리 완료', 1);
            } else {
                console.log('국채금리 데이터 로드 실패 - 빈 차트로 표시');
                updateProgress(25, '국채금리 데이터 실패 (refresh 버튼으로 재시도 가능)', 1);
            }
            
            // 2. CPI 데이터 로딩 (25% → 50%)
            updateProgress(40, 'CPI 데이터를 처리하고 있습니다...', 1);
            const cpiSuccess = await processCPIData();
            if (cpiSuccess) {
                updateProgress(50, 'CPI 데이터 처리 완료', 2);
            } else {
                console.log('CPI 데이터 로드 실패 - 빈 차트로 표시');
                updateProgress(50, 'CPI 데이터 실패 (refresh 버튼으로 재시도 가능)', 2);
            }
            
            // 3. 제조업 생산지수 데이터 로딩 (50% → 75%)
            updateProgress(65, '제조업 생산지수 데이터를 처리하고 있습니다...', 2);
            const indproSuccess = await processIndustrialProductionData();
            if (indproSuccess) {
                updateProgress(75, '제조업 생산지수 데이터 처리 완료', 3);
            } else {
                console.log('제조업 생산지수 데이터 로드 실패 - 빈 차트로 표시');
                updateProgress(75, '제조업 생산지수 데이터 실패 (refresh 버튼으로 재시도 가능)', 3);
            }
            
            // 4. 실업률 데이터 로딩 (75% → 85%)
            updateProgress(80, '실업률 데이터를 처리하고 있습니다...', 3);
            const unemploymentSuccess = await processUnemploymentData();
            if (unemploymentSuccess) {
                updateProgress(85, '실업률 데이터 처리 완료', 4);
            } else {
                console.log('실업률 데이터 로드 실패 - 빈 차트로 표시');
                updateProgress(85, '실업률 데이터 실패 (refresh 버튼으로 재시도 가능)', 4);
            }
            
            // 5. GDP 데이터 로딩 (85% → 87%)
            updateProgress(86, 'GDP 데이터를 처리하고 있습니다...', 4);
            const gdpSuccess = await processGDPData();
            if (gdpSuccess) {
                updateProgress(87, 'GDP 데이터 처리 완료', 5);
            } else {
                console.log('GDP 데이터 로드 실패 - 빈 차트로 표시');
                updateProgress(87, 'GDP 데이터 실패 (refresh 버튼으로 재시도 가능)', 5);
            }
            
            // 6. S&P 500 데이터 로딩 (87% → 92%)
            updateProgress(90, 'S&P 500 데이터를 처리하고 있습니다...', 5);
            const sp500Success = await processSP500Data();
            if (sp500Success) {
                updateProgress(92, 'S&P 500 데이터 처리 완료', 6);
            } else {
                console.log('S&P 500 데이터 로드 실패 - 빈 차트로 표시');
                updateProgress(92, 'S&P 500 데이터 실패 (refresh 버튼으로 재시도 가능)', 6);
            }
            
            // 7. 버핏지수 데이터 로딩 (92% → 94%)
            updateProgress(93, '버핏지수 데이터를 처리하고 있습니다...', 6);
            const buffettSuccess = await processBuffettIndicatorData();
            if (buffettSuccess) {
                updateProgress(94, '버핏지수 데이터 처리 완료', 7);
            } else {
                console.log('버핏지수 데이터 로드 실패 - 빈 차트로 표시');
                updateProgress(94, '버핏지수 데이터 실패 (refresh 버튼으로 재시도 가능)', 7);
            }
            
            // 8. 주택재고량 데이터 로딩 (94% → 96%)
            updateProgress(95, '주택재고량 데이터를 처리하고 있습니다...', 7);
            const housingSuccess = await processHousingInventoryData();
            if (housingSuccess) {
                updateProgress(96, '주택재고량 데이터 처리 완료', 8);
            } else {
                console.log('주택재고량 데이터 로드 실패 - 빈 차트로 표시');
                updateProgress(96, '주택재고량 데이터 실패 (refresh 버튼으로 재시도 가능)', 8);
            }
            
            // 9. 모기지 연체율 데이터 로딩 (96% → 100%)
            updateProgress(98, '모기지 연체율 데이터를 처리하고 있습니다...', 8);
            const mortgageSuccess = await processMortgageDelinquencyData();
            if (mortgageSuccess) {
                updateProgress(100, '모든 데이터 로딩 완료!', 9);
            } else {
                console.log('모기지 연체율 데이터 로드 실패 - 빈 차트로 표시');
                updateProgress(100, '모기지 연체율 데이터 실패 (refresh 버튼으로 재시도 가능)', 9);
            }
            
            // 차트 표시
            showChart();
            
            // 잠시 후 로딩 완료
            setTimeout(() => {
                hideLoading();
            }, 500);
            
        } catch (error) {
            console.error('데이터 로딩 오류:', error);
            showError('데이터를 가져오는 중 오류가 발생했습니다.');
        }
    }
    
    // 국채금리 데이터 처리 함수
    async function processTreasuryData() {
        try {
            const response = await fetch('/api/economy/treasury/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayTreasuryChart(result.chart_data);
                console.log(result.message);
                return true;
            } else {
                console.error('국채금리 데이터 처리 실패:', result.error);
                return false;
            }
        } catch (error) {
            console.error('국채금리 데이터 처리 오류:', error);
            return false;
        }
    }
    
    // CPI 데이터 처리 함수
    async function processCPIData() {
        try {
            const response = await fetch('/api/economy/cpi/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayCPIChart(result.chart_data);
                console.log(result.message);
                return true;
            } else {
                console.error('CPI 데이터 처리 실패:', result.error);
                return false;
            }
        } catch (error) {
            console.error('CPI 데이터 처리 오류:', error);
            return false;
        }
    }
    
    // 제조업 생산지수 데이터 처리 함수
    async function processIndustrialProductionData() {
        try {
            const response = await fetch('/api/economy/industrial-production/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayIndustrialProductionChart(result.chart_data);
                console.log(result.message);
                return true;
            } else {
                console.error('제조업 생산지수 데이터 처리 실패:', result.error);
                return false;
            }
        } catch (error) {
            console.error('제조업 생산지수 데이터 처리 오류:', error);
            return false;
        }
    }
    
    // 실업률 데이터 처리 함수
    async function processUnemploymentData() {
        try {
            const response = await fetch('/api/economy/unemployment/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayUnemploymentChart(result.chart_data);
                console.log(result.message);
                return true;
            } else {
                console.error('실업률 데이터 처리 실패:', result.error);
                return false;
            }
        } catch (error) {
            console.error('실업률 데이터 처리 오류:', error);
            return false;
        }
    }
    
    // GDP 데이터 처리 함수
    async function processGDPData() {
        try {
            const response = await fetch('/api/economy/gdp/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayGDPChart(result.chart_data);
                console.log(result.message);
                return true;
            } else {
                console.error('GDP 데이터 처리 실패:', result.error);
                return false;
            }
        } catch (error) {
            console.error('GDP 데이터 처리 오류:', error);
            return false;
        }
    }
    
    // S&P 500 데이터 처리 함수
    async function processSP500Data() {
        try {
            const response = await fetch('/api/economy/sp500/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displaySP500Chart(result.chart_data);
                console.log(result.message);
                return true;
            } else {
                console.error('S&P 500 데이터 처리 실패:', result.error);
                return false;
            }
        } catch (error) {
            console.error('S&P 500 데이터 처리 오류:', error);
            return false;
        }
    }
    
    // 버핏지수 데이터 처리 함수
    async function processBuffettIndicatorData() {
        try {
            const response = await fetch('/api/economy/buffett-indicator/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayBuffettIndicatorChart(result.chart_data);
                console.log(result.message);
                return true;
            } else {
                console.error('버핏지수 데이터 처리 실패:', result.error);
                return false;
            }
        } catch (error) {
            console.error('버핏지수 데이터 처리 오류:', error);
            return false;
        }
    }
    
    // 주택재고량 데이터 처리 함수
    async function processHousingInventoryData() {
        try {
            const response = await fetch('/api/economy/housing-inventory/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayHousingInventoryChart(result.chart_data);
                console.log(result.message);
                return true;
            } else {
                console.error('주택재고량 데이터 처리 실패:', result.error);
                return false;
            }
        } catch (error) {
            console.error('주택재고량 데이터 처리 오류:', error);
            return false;
        }
    }
    
    // 모기지 연체율 데이터 처리 함수
    async function processMortgageDelinquencyData() {
        try {
            const response = await fetch('/api/economy/mortgage-delinquency/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayMortgageDelinquencyChart(result.chart_data);
                console.log(result.message);
                return true;
            } else {
                console.error('모기지 연체율 데이터 처리 실패:', result.error);
                return false;
            }
        } catch (error) {
            console.error('모기지 연체율 데이터 처리 오류:', error);
            return false;
        }
    }
    
    // 국채금리 차트 표시
    function displayTreasuryChart(chartData) {
        if (!chartData || !chartData.labels || chartData.labels.length === 0) {
            console.error('국채금리 차트 데이터를 생성할 수 없습니다.');
            return;
        }
        
        console.log('국채금리 차트 데이터:', chartData);
        
        // 기존 차트 제거
        const existingChart = Chart.getChart('treasuryChart');
        if (existingChart) {
            existingChart.destroy();
        }
        
        // 국채금리 차트 생성 (두 개의 라인)
        const ctx = document.getElementById('treasuryChart').getContext('2d');
        treasuryChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: '5년물 금리 (%)',
                        data: chartData.treasury_5y,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1,
                        borderWidth: 2
                    },
                    {
                        label: '3개월물 금리 (%)',
                        data: chartData.treasury_3m,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '미국 국채금리 추이 (분기별)'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(4) + '%';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: '금리 (%)'
                        },
                        beginAtZero: false
                    },
                    x: {
                        title: {
                            display: true,
                            text: '분기'
                        }
                    }
                }
            }
        });
    }
    
    // CPI 차트 표시
    function displayCPIChart(chartData) {
        if (!chartData || !chartData.labels || chartData.labels.length === 0) {
            console.error('CPI 차트 데이터를 생성할 수 없습니다.');
            return;
        }
        
        console.log('CPI 차트 데이터:', chartData);
        
        // 기존 차트 제거
        const existingChart = Chart.getChart('cpiChart');
        if (existingChart) {
            existingChart.destroy();
        }
        
        // CPI 차트 생성
        const ctx = document.getElementById('cpiChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'CPI (소비자물가지수)',
                        data: chartData.cpi_values,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        borderWidth: 2,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'CPI 추이 (분기별)'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'CPI Index'
                        },
                        beginAtZero: false
                    },
                    x: {
                        title: {
                            display: true,
                            text: '분기'
                        }
                    }
                }
            }
        });
    }
    
    // 제조업 생산지수 차트 표시
    function displayIndustrialProductionChart(chartData) {
        if (!chartData || !chartData.labels || chartData.labels.length === 0) {
            console.error('제조업 생산지수 차트 데이터를 생성할 수 없습니다.');
            return;
        }
        
        console.log('제조업 생산지수 차트 데이터:', chartData);
        
        // 기존 차트 제거
        const existingChart = Chart.getChart('indproChart');
        if (existingChart) {
            existingChart.destroy();
        }
        
        // 제조업 생산지수 차트 생성
        const ctx = document.getElementById('indproChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: '제조업 생산지수 (Index)',
                        data: chartData.indpro_values,
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.1,
                        borderWidth: 2,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '제조업 생산지수 추이 (분기별)'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Production Index (2017=100)'
                        },
                        beginAtZero: false
                    },
                    x: {
                        title: {
                            display: true,
                            text: '분기'
                        }
                    }
                }
            }
        });
    }
    
    // 실업률 차트 표시
    function displayUnemploymentChart(chartData) {
        if (!chartData || !chartData.labels || chartData.labels.length === 0) {
            console.error('실업률 차트 데이터를 생성할 수 없습니다.');
            return;
        }
        
        console.log('실업률 차트 데이터:', chartData);
        
        // 기존 차트 제거
        const existingChart = Chart.getChart('unemploymentChart');
        if (existingChart) {
            existingChart.destroy();
        }
        
        // 실업률 차트 생성
        const ctx = document.getElementById('unemploymentChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: '실업률 (%)',
                        data: chartData.unemployment_values,
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        tension: 0.1,
                        borderWidth: 2,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '실업률 추이 (분기별)'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Unemployment Rate (%)'
                        },
                        beginAtZero: true
                    },
                    x: {
                        title: {
                            display: true,
                            text: '분기'
                        }
                    }
                }
            }
        });
    }
    
    // GDP 차트 표시
    function displayGDPChart(chartData) {
        if (!chartData || !chartData.labels || chartData.labels.length === 0) {
            console.error('GDP 차트 데이터를 생성할 수 없습니다.');
            return;
        }
        
        console.log('GDP 차트 데이터:', chartData);
        
        // 기존 차트 제거
        const existingChart = Chart.getChart('gdpChart');
        if (existingChart) {
            existingChart.destroy();
        }
        
        // GDP 차트 생성
        const ctx = document.getElementById('gdpChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'GDP (Billion Chained 2017 Dollars)',
                        data: chartData.gdp_values,
                        borderColor: 'rgb(54, 235, 162)',
                        backgroundColor: 'rgba(54, 235, 162, 0.2)',
                        tension: 0.1,
                        borderWidth: 2,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'GDP 추이 (분기별)'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += '$' + context.parsed.y.toFixed(2) + 'B';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Real GDP (Billion Dollars)'
                        },
                        beginAtZero: false
                    },
                    x: {
                        title: {
                            display: true,
                            text: '분기'
                        }
                    }
                }
            }
        });
    }
    
    // S&P 500 차트 표시
    function displaySP500Chart(chartData) {
        if (!chartData || !chartData.labels || chartData.labels.length === 0) {
            console.error('S&P 500 차트 데이터를 생성할 수 없습니다.');
            return;
        }
        
        console.log('S&P 500 차트 데이터:', chartData);
        
        // 기존 차트 제거
        const existingChart = Chart.getChart('sp500Chart');
        if (existingChart) {
            existingChart.destroy();
        }
        
        // S&P 500 차트 생성
        const ctx = document.getElementById('sp500Chart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'S&P 500 Index',
                        data: chartData.sp500_values,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        borderWidth: 3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'S&P 500 지수 추이 (분기별)'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Index Value'
                        },
                        beginAtZero: false
                    },
                    x: {
                        title: {
                            display: true,
                            text: '분기'
                        }
                    }
                }
            }
        });
    }
    
    // 버핏지수 차트 표시
    function displayBuffettIndicatorChart(chartData) {
        if (!chartData || !chartData.labels || chartData.labels.length === 0) {
            console.error('버핏지수 차트 데이터를 생성할 수 없습니다.');
            return;
        }
        
        console.log('버핏지수 차트 데이터:', chartData);
        
        // 기존 차트 제거
        const existingChart = Chart.getChart('buffettIndicatorChart');
        if (existingChart) {
            existingChart.destroy();
        }
        
        // 버핏지수 차트 생성
        const ctx = document.getElementById('buffettIndicatorChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: '버핏지수 (%)',
                        data: chartData.buffett_ratio_values,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        borderWidth: 3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '버핏지수 추이 (분기별)'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: 100,
                                yMax: 100,
                                borderColor: 'rgb(75, 192, 192)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: '적정 수준 (100%)',
                                    enabled: true,
                                    position: 'end'
                                }
                            },
                            line2: {
                                type: 'line',
                                yMin: 115,
                                yMax: 115,
                                borderColor: 'rgb(255, 159, 64)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: '과대평가 기준 (115%)',
                                    enabled: true,
                                    position: 'end'
                                }
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Buffett Indicator (%)'
                        },
                        beginAtZero: false
                    },
                    x: {
                        title: {
                            display: true,
                            text: '분기'
                        }
                    }
                }
            }
        });
    }
    
    // 주택재고량 차트 표시
    function displayHousingInventoryChart(chartData) {
        if (!chartData || !chartData.labels || chartData.labels.length === 0) {
            console.error('주택재고량 차트 데이터를 생성할 수 없습니다.');
            return;
        }
        
        console.log('주택재고량 차트 데이터:', chartData);
        
        // 기존 차트 제거
        const existingChart = Chart.getChart('housingInventoryChart');
        if (existingChart) {
            existingChart.destroy();
        }
        
        // 주택재고량 차트 생성
        const ctx = document.getElementById('housingInventoryChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: '주택재고량 (개월)',
                        data: chartData.inventory_values,
                        borderColor: 'rgb(255, 206, 86)',
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        tension: 0.1,
                        borderWidth: 3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '주택재고량 추이 (분기별)'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1) + '개월';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: '월별 공급 (개월)'
                        },
                        beginAtZero: false
                    },
                    x: {
                        title: {
                            display: true,
                            text: '분기'
                        }
                    }
                }
            }
        });
    }
    
    // 국채금리 데이터 새로고침
    async function refreshTreasuryData() {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';
        
        // 차트 로딩 표시
        document.getElementById('treasuryChartLoading').style.display = 'flex';
        
        try {
            const response = await fetch('/api/economy/treasury/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayTreasuryChart(result.chart_data);
                document.getElementById('treasuryChartLoading').style.display = 'none';
                
                if (result.deleted_count > 0) {
                    showAlert(result.message || `국채금리 데이터 ${result.deleted_count}개를 새로고침했습니다.`, 'success');
                }
            } else {
                document.getElementById('treasuryChartLoading').style.display = 'none';
                console.log('국채금리 새로고침 실패 - 차트는 유지');
            }
        } catch (error) {
            document.getElementById('treasuryChartLoading').style.display = 'none';
            console.error('국채금리 새로고침 오류:', error);
        }
    }
    
    // CPI 데이터 새로고침
    async function refreshCPIData() {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';
        
        // 차트 로딩 표시
        document.getElementById('cpiChartLoading').style.display = 'flex';
        
        try {
            const response = await fetch('/api/economy/cpi/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayCPIChart(result.chart_data);
                document.getElementById('cpiChartLoading').style.display = 'none';
                
                if (result.deleted_count > 0) {
                    showAlert(result.message || `CPI 데이터 ${result.deleted_count}개를 새로고침했습니다.`, 'success');
                }
            } else {
                document.getElementById('cpiChartLoading').style.display = 'none';
                console.log('CPI 새로고침 실패 - 차트는 유지');
            }
        } catch (error) {
            document.getElementById('cpiChartLoading').style.display = 'none';
            console.error('CPI 새로고침 오류:', error);
        }
    }
    
    // 제조업 생산지수 데이터 새로고침
    async function refreshIndustrialProductionData() {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';
        
        // 차트 로딩 표시
        document.getElementById('indproChartLoading').style.display = 'flex';
        
        try {
            const response = await fetch('/api/economy/industrial-production/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayIndustrialProductionChart(result.chart_data);
                document.getElementById('indproChartLoading').style.display = 'none';
                
                if (result.deleted_count > 0) {
                    showAlert(result.message || `제조업 생산지수 데이터 ${result.deleted_count}개를 새로고침했습니다.`, 'success');
                }
            } else {
                document.getElementById('indproChartLoading').style.display = 'none';
                console.log('제조업 생산지수 새로고침 실패 - 차트는 유지');
            }
        } catch (error) {
            document.getElementById('indproChartLoading').style.display = 'none';
            console.error('제조업 생산지수 새로고침 오류:', error);
        }
    }
    
    // 실업률 데이터 새로고침
    async function refreshUnemploymentData() {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';
        
        // 차트 로딩 표시
        document.getElementById('unemploymentChartLoading').style.display = 'flex';
        
        try {
            const response = await fetch('/api/economy/unemployment/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayUnemploymentChart(result.chart_data);
                document.getElementById('unemploymentChartLoading').style.display = 'none';
                
                if (result.deleted_count > 0) {
                    showAlert(result.message || `실업률 데이터 ${result.deleted_count}개를 새로고침했습니다.`, 'success');
                }
            } else {
                document.getElementById('unemploymentChartLoading').style.display = 'none';
                console.log('실업률 새로고침 실패 - 차트는 유지');
            }
        } catch (error) {
            document.getElementById('unemploymentChartLoading').style.display = 'none';
            console.error('실업률 새로고침 오류:', error);
        }
    }
    
    // GDP 데이터 새로고침
    async function refreshGDPData() {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';
        
        // 차트 로딩 표시
        document.getElementById('gdpChartLoading').style.display = 'flex';
        
        try {
            const response = await fetch('/api/economy/gdp/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayGDPChart(result.chart_data);
                document.getElementById('gdpChartLoading').style.display = 'none';
                
                if (result.deleted_count > 0) {
                    showAlert(result.message || `GDP 데이터 ${result.deleted_count}개를 새로고침했습니다.`, 'success');
                }
            } else {
                document.getElementById('gdpChartLoading').style.display = 'none';
                console.log('GDP 새로고침 실패 - 차트는 유지');
            }
        } catch (error) {
            document.getElementById('gdpChartLoading').style.display = 'none';
            console.error('GDP 새로고침 오류:', error);
        }
    }
    
    // S&P 500 데이터 새로고침
    async function refreshSP500Data() {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';
        
        // 차트 로딩 표시
        document.getElementById('sp500ChartLoading').style.display = 'flex';
        
        try {
            const response = await fetch('/api/economy/sp500/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displaySP500Chart(result.chart_data);
                document.getElementById('sp500ChartLoading').style.display = 'none';
                
                if (result.deleted_count > 0) {
                    showAlert(result.message || `S&P 500 데이터 ${result.deleted_count}개를 새로고침했습니다.`, 'success');
                }
            } else {
                document.getElementById('sp500ChartLoading').style.display = 'none';
                console.log('S&P 500 새로고침 실패 - 차트는 유지');
            }
        } catch (error) {
            document.getElementById('sp500ChartLoading').style.display = 'none';
            console.error('S&P 500 새로고침 오류:', error);
        }
    }
    
    // 버핏지수 데이터 새로고침
    async function refreshBuffettIndicatorData() {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';
        
        // 차트 로딩 표시
        document.getElementById('buffettIndicatorChartLoading').style.display = 'flex';
        
        try {
            const response = await fetch('/api/economy/buffett-indicator/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayBuffettIndicatorChart(result.chart_data);
                document.getElementById('buffettIndicatorChartLoading').style.display = 'none';
                
                if (result.deleted_count > 0) {
                    showAlert(result.message || `버핏지수 데이터 ${result.deleted_count}개를 새로고침했습니다.`, 'success');
                }
            } else {
                document.getElementById('buffettIndicatorChartLoading').style.display = 'none';
                console.log('버핏지수 새로고침 실패 - 차트는 유지');
            }
        } catch (error) {
            document.getElementById('buffettIndicatorChartLoading').style.display = 'none';
            console.error('버핏지수 새로고침 오류:', error);
        }
    }
    
    // 주택재고량 데이터 새로고침
    async function refreshHousingInventoryData() {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';
        
        // 차트 로딩 표시
        document.getElementById('housingInventoryChartLoading').style.display = 'flex';
        
        try {
            const response = await fetch('/api/economy/housing-inventory/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayHousingInventoryChart(result.chart_data);
                document.getElementById('housingInventoryChartLoading').style.display = 'none';
                
                if (result.deleted_count > 0) {
                    showAlert(result.message || `주택재고량 데이터 ${result.deleted_count}개를 새로고침했습니다.`, 'success');
                }
            } else {
                document.getElementById('housingInventoryChartLoading').style.display = 'none';
                console.log('주택재고량 새로고침 실패 - 차트는 유지');
            }
        } catch (error) {
            document.getElementById('housingInventoryChartLoading').style.display = 'none';
            console.error('주택재고량 새로고침 오류:', error);
        }
    }
    
    // 모기지 연체율 차트 표시
    function displayMortgageDelinquencyChart(chartData) {
        if (!chartData || !chartData.labels || chartData.labels.length === 0) {
            console.error('모기지 연체율 차트 데이터를 생성할 수 없습니다.');
            return;
        }
        
        console.log('모기지 연체율 차트 데이터:', chartData);
        
        // 기존 차트 제거
        const existingChart = Chart.getChart('mortgageDelinquencyChart');
        if (existingChart) {
            existingChart.destroy();
        }
        
        // 모기지 연체율 차트 생성
        const ctx = document.getElementById('mortgageDelinquencyChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: '모기지 연체율 (%)',
                        data: chartData.delinquency_values,
                        borderColor: 'rgb(220, 53, 69)',
                        backgroundColor: 'rgba(220, 53, 69, 0.2)',
                        tension: 0.1,
                        borderWidth: 3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '모기지 연체율 추이 (분기별)'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: '연체율 (%)'
                        },
                        beginAtZero: false
                    },
                    x: {
                        title: {
                            display: true,
                            text: '분기'
                        }
                    }
                }
            }
        });
    }
    
    // 모기지 연체율 데이터 새로고침
    async function refreshMortgageDelinquencyData() {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';
        
        // 차트 로딩 표시
        document.getElementById('mortgageDelinquencyChartLoading').style.display = 'flex';
        
        try {
            const response = await fetch('/api/economy/mortgage-delinquency/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayMortgageDelinquencyChart(result.chart_data);
                document.getElementById('mortgageDelinquencyChartLoading').style.display = 'none';
                
                if (result.deleted_count > 0) {
                    showAlert(result.message || `모기지 연체율 데이터 ${result.deleted_count}개를 새로고침했습니다.`, 'success');
                }
            } else {
                document.getElementById('mortgageDelinquencyChartLoading').style.display = 'none';
                console.log('모기지 연체율 새로고침 실패 - 차트는 유지');
            }
        } catch (error) {
            document.getElementById('mortgageDelinquencyChartLoading').style.display = 'none';
            console.error('모기지 연체율 새로고침 오류:', error);
        }
    }
    
    // 알림 표시 함수
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // 3초 후 자동 제거
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
</script>
{% endblock %}
