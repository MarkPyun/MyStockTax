{% extends "base.html" %}

{% block title %}MyStockTax - 홈{% endblock %}

{% block content %}
<!-- 어두운 테마 홈 화면 -->
<div class="dark-home-container">
    <!-- 상단 로고 영역 -->
    <div class="logo-section">
        <div class="logo-container">
            <div class="logo-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
        </div>
        <div class="active-indicator"></div>
    </div>

    <!-- 메인 검색 영역 -->
    <div class="search-section">
        <div class="search-container">
            <!-- 드롭다운 버튼 -->
            <div class="dropdown-btn">
                <i class="fas fa-chevron-up"></i>
                <div class="dropdown-arrow"></div>
            </div>
            
            <!-- 메인 검색 바 -->
            <div class="main-search-bar">
                <input type="text" class="search-input" placeholder="종목명, 종목코드, 키워드를 입력하세요..." id="mainSearchInput">
                <div class="search-controls">
                    <button class="clear-btn" onclick="clearSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="search-btn" onclick="performSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 빠른 액션 버튼들 -->
    <div class="quick-actions">
        <button class="action-btn" onclick="showAddStockModal()">
            <i class="fas fa-plus"></i>
            <span>주식 추가</span>
        </button>
        <button class="action-btn" onclick="showAddTransactionModal()">
            <i class="fas fa-exchange-alt"></i>
            <span>거래 기록</span>
        </button>
        <button class="action-btn" onclick="showPortfolio()">
            <i class="fas fa-chart-line"></i>
            <span>포트폴리오</span>
        </button>
    </div>
</div>


<!-- 주식 추가 모달 -->
<div class="modal fade" id="addStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>새 주식 추가
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStockForm">
                    <div class="mb-3">
                        <label for="stockName" class="form-label">종목명</label>
                        <input type="text" class="form-control" id="stockName" required>
                    </div>
                    <div class="mb-3">
                        <label for="stockSymbol" class="form-label">종목 코드</label>
                        <input type="text" class="form-control" id="stockSymbol" required>
                    </div>
                    <div class="mb-3">
                        <label for="stockQuantity" class="form-label">보유 수량</label>
                        <input type="number" class="form-control" id="stockQuantity" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="stockPrice" class="form-label">현재 가격</label>
                        <input type="number" class="form-control" id="stockPrice" min="0" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="addStock()">추가</button>
            </div>
        </div>
    </div>
</div>

<!-- 거래 추가 모달 -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>거래 기록 추가
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTransactionForm">
                    <div class="mb-3">
                        <label for="transactionStock" class="form-label">종목 선택</label>
                        <select class="form-select" id="transactionStock" required>
                            <option value="">종목을 선택하세요</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="transactionType" class="form-label">거래 유형</label>
                        <select class="form-select" id="transactionType" required>
                            <option value="">선택하세요</option>
                            <option value="buy">매수</option>
                            <option value="sell">매도</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="transactionQuantity" class="form-label">수량</label>
                        <input type="number" class="form-control" id="transactionQuantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="transactionPrice" class="form-label">가격</label>
                        <input type="number" class="form-control" id="transactionPrice" min="0" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="transactionDate" class="form-label">거래 날짜</label>
                        <input type="date" class="form-control" id="transactionDate" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="addTransaction()">추가</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        setupTransactionDate();
    });

    // 검색 기능
    function performSearch() {
        const searchTerm = document.getElementById('mainSearchInput').value.trim();
        if (searchTerm) {
            showAlert(`"${searchTerm}" 검색 결과를 준비 중입니다.`, 'info');
            // 실제 검색 로직 구현 예정
        } else {
            showAlert('검색어를 입력해주세요.', 'warning');
        }
    }

    // 검색어 지우기
    function clearSearch() {
        document.getElementById('mainSearchInput').value = '';
        document.getElementById('mainSearchInput').focus();
    }

    // 엔터키로 검색
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('mainSearchInput');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }
    });

    // 모달 표시 함수들
    function showAddStockModal() {
        const modal = new bootstrap.Modal(document.getElementById('addStockModal'));
        modal.show();
    }

    function showAddTransactionModal() {
        loadStocksForTransaction();
        const modal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
        modal.show();
    }

    // 거래용 종목 목록 로드
    async function loadStocksForTransaction() {
        try {
            const stocks = await apiCall('/api/stocks');
            const select = document.getElementById('transactionStock');
            
            select.innerHTML = '<option value="">종목을 선택하세요</option>';
            stocks.forEach(stock => {
                select.innerHTML += `<option value="${stock.id}">${stock.name} (${stock.symbol})</option>`;
            });
        } catch (error) {
            console.error('종목 목록 로드 오류:', error);
        }
    }

    // 주식 추가
    async function addStock() {
        const form = document.getElementById('addStockForm');
        const formData = {
            name: document.getElementById('stockName').value,
            symbol: document.getElementById('stockSymbol').value,
            quantity: parseInt(document.getElementById('stockQuantity').value),
            price: parseFloat(document.getElementById('stockPrice').value)
        };

        try {
            await apiCall('/api/stocks', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            showAlert('주식이 성공적으로 추가되었습니다.', 'success');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('addStockModal')).hide();
        } catch (error) {
            console.error('주식 추가 오류:', error);
        }
    }

    // 거래 추가
    async function addTransaction() {
        const form = document.getElementById('addTransactionForm');
        const formData = {
            stock_id: parseInt(document.getElementById('transactionStock').value),
            type: document.getElementById('transactionType').value,
            quantity: parseInt(document.getElementById('transactionQuantity').value),
            price: parseFloat(document.getElementById('transactionPrice').value),
            date: document.getElementById('transactionDate').value
        };

        try {
            await apiCall('/api/transactions', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            showAlert('거래가 성공적으로 기록되었습니다.', 'success');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
        } catch (error) {
            console.error('거래 추가 오류:', error);
        }
    }

    // 포트폴리오 보기
    function showPortfolio() {
        window.location.href = '/stock-analysis';
    }

    // 거래 날짜 기본값 설정
    function setupTransactionDate() {
        const dateInput = document.getElementById('transactionDate');
        if (dateInput) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
    }
</script>
{% endblock %}
